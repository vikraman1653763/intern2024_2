
{% extends 'base.html' %}

{% block body %}

<link rel="stylesheet" href="/static/styles/mapstyle.css">
<link rel="stylesheet" href="/static/styles/popup.css">

<div class="row">
   
    <div class="col-sm-10 allButtonBar">
        <div class='mainbtnBar'>
        <button id="togglelayer" class="myButton mainBtn toolbtn" ><img src="\static\resources\images\layers.svg"alt=""><span class=" maintip">Layers</span></button>
        <button id="metricButton" class="myButton mainBtn toolbtn"><img src="\static\resources\images\book.svg" alt=""><span class=" maintip">Metrics</span></button>
        <button id="toolButton" class="myButton mainBtn toolbtn"><img src="\static\resources\images\edit.svg" alt=""><span class=" maintip">Tools</span></button>
        <button id="imageButton" class="myButton mainBtn toolbtn"><img src="/static/resources/images/photo.svg" alt="" /><span class="maintip">Images</span></button>
        <button id="docsButton" class="myButton mainBtn toolbtn"><img src="/static/resources/images/docs.svg" alt="" /><span class="maintip">Docs</span></button>   
    </div>
        <button id="homeButton" class="myButton toolbtn">
            <img src="/static/resources/images/homebtn.svg" alt="exit" />
            <span class="maintip tooltip ">exit</span>
        </button>
    
        <div class="tooly">
            <div class="btnBar">
            
            <button id="fsButton" class="myButton toolbtn">
                <img src="/static/resources/images/full.svg" alt="" />
                <span class="tooltip">Fullscreen</span>
            </button>
            <button id="infoButton" class="myButton toolbtn">
                <img src="/static/resources/images/info.svg" alt="" />
                <span class="tooltip">Info</span>
            </button>   
              
        </div>
            <div class='btnBar'>
            <!-- Zoom Out Button -->
                <button id="zoButton" class=" myButton toolbtn">
                    <img src="/static/resources/images/zoomminus.svg" alt="" />
                    <span class="tooltip">Zoom&nbsp;Out</span>
                </button>
                <!-- Zoom In Button -->
                <button id="ziButton" class="  myButton toolbtn">
                    <img src="/static/resources/images/zoomplus.svg" alt="" />
                    <span class="tooltip">Zoom&nbsp;In</span>
                </button>
            </div>
            <div class='btnBar'>
            <!-- Length Control Button -->
            <button id="lengthButton" class=" myButton toolbtn">
                <img src="/static/resources/images/scale.svg" alt="" />
                <span class="tooltip">Length</span>
            </button>
            <!-- Area Control Button -->
            <button id="areaButton" class=" myButton toolbtn">
                <img src="/static/resources/images/area.svg" alt="" />
                <span class="tooltip">Area</span>
            </button>
            <!-- Full Screen Button -->
            <button id="ptButton" class=" myButton toolbtn">
                <img src="/static/resources/images/pointer.svg" alt="" />
                <span class="tooltip">pointer</span>
            </button>
        </div>
        </div>
        
        
        </div>
        <div id="map"></div>
        
        <div id="sidebar" >
            <div class="checkbox-wrapper">
                <h2>Layers</h2>
                <input type="checkbox" class="tick_mark" checked='checked' id="toggleAllLayers"> 
                <label for="toggleAllLayers"><div class="tick_mark"></div></label>
            </div>
            
            <div class='layerNames'>
                <br>
                <div class="checkbox-wrapper">
                    <input id="googleMaps" type="checkbox" value="Google Maps" checked onchange="toggleLayer(event)">
                    <label for="googleMaps"><div class="tick_mark"></div></label>
                    <span>Google Maps</span>
                </div>
                <br>
                <div class="checkbox-wrapper">
                    <input id="googleSatellite" type="checkbox" value="Google Satellite" checked onchange="toggleLayer(event)">
                    <label for="googleSatellite"><div class="tick_mark"></div></label>
                    <span>Satellite</span>
                </div>
                
                <br>
                {% for l in layer_list %}
                <div class="checkbox-wrapper">
                    <input class="layer-checkbox" id="{{ l }}" type="checkbox" value="{{ l }}" checked onchange="toggleLayer(event)">
                    <label for="{{ l }}"><div class="tick_mark"></div></label>
                    <span >{{ l }}</span>
                </div>
                <br>
                {% endfor %}
            </div>
        </div>
    </div>     
          
        <div id="imageContainer"></div>
        <div id="documentListContainer"></div>
<!-- Popup Container -->
<div id="popupImageContainer" class="popupImageContainer">
    <span class="close" onclick="closePopup()">&times;</span>
    <img id="popupImage" src="" alt="Popup Image">
</div>

    <!--popup for metric-->
        <div id="popupDialog" class="popup">
            <div class="popup-content">
                <span class="popup-close">&times;</span>
                <p class="popup-p">Enter&nbsp;name:</p>
                <div class="popup-in">
                    <input class="popup-input" type="text" id="pointerName" placeholder="Pointer Name">
                    <button id='submitName'class="popup-button"><span>Submit</span></button>
                </div>
            </div>
        </div>
    </div>
    
    
    <div class='metricbar'>
        <div class="metric-section">
            <h5><img class='metimg' src="\static\resources\images\ptmet.svg" alt="">Points</h5>
            <div id="pointNames" class="metric-list"></div>
        </div>
        <div class="metric-section">
            <h5><img class='metimg' src="\static\resources\images\areamet.svg" alt="">Polygon</h5>
            <div id="polygonNames" class="metric-list"></div>
        </div>
        <div class="metric-section">
            <h5><img class='metimg' src="\static\resources\images\lengthmet.svg" alt="">Line</h5>
            <div id="lineNames" class="metric-list"></div>
        </div>
    </div>
    <!--popup for Loading-->
    
    <div id="loadingPopup" class="loading-popup">
        <div class="loading-content">
            <div class="spinner"></div>
            
        </div>
    </div>
    
        <div id="attributeContainer">
            <div class="attributeHeader"></div>
            <div class="attributeRows"></div>
        </div>
        
        <!--popup for Pointer-->
        <div id="pointerDialog" class="pointerup">
            <div class="point-content">
                <span class="pointer-close">&times;</span>
                <div class="pointer-info">
                    <p id="pointerNameDisplay"></p>
                    <p id="pointerLongitudeDisplay"></p>
                    <p id="pointerLatitudeDisplay"></p>
                </div>
            </div>
        </div>
        
        <!--popup for feature-->
        <div id="popup"  class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer"></a>
            <div id="popup-content"></div>
        </div> 
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/ol@6.8.0/dist/ol.js"></script>
        <script src="/static/js/reload.js"></script>
        <script src="/static/resources/ol/ol.js"></script>
        <script src="/static/resources/layerswitcher/ol-layerswitcher.js"></script>
        <script src="/static/js/MapView.js"></script>
        <script src="/static/js/controls.js"></script>
        <script src="/static/js/pointer.js"></script>
        <script src="/static/js/showmetric.js"></script>
        <script src="/static/js/storepolyline.js"></script>
        <script src="/static/js/deletemetrics.js"></script>
        
        <script src="/static/js/filter.js"></script>
        <script src="/static/js/addInteraction.js"></script>
        <script src="/static/js/formatLengthArea.js"></script>
        <script src="/static/js/createToolTip.js"></script>
        <script src="/static/js/toggleSlide.js"></script>
        <script src="/static/js/featureinfo.js"></script>
        <script src="/static/js/imageDocSlide.js"></script>
        
        <script>
            document.querySelectorAll('.myButton').forEach(button => {
                button.addEventListener('click', function() {
                    this.classList.toggle('active');
                });
            });
        </script>



<script  type="text/javascript">
    var dashboardUrl = "{{ url_for('dashboard') }}";
    var projectId={{ id }};
    var layer_names=[];
    var helpTooltipElement;
    var helpTooltip;
    var measureTooltipElement;
    var measureTooltip;
    var draw; // global so we can remove it later
    toggleImageSlide(projectId);  
    toggleDocSlide(projectId);  
    //mapView   
    var map = mapView(
        JSON.parse('{{ lay | safe }}'),
        JSON.parse('{{ workspace | safe }}'),
        JSON.parse('{{ ngrok_ip | safe }}'),
        JSON.parse('{{ lon | safe }}'),
        JSON.parse('{{ lat | safe }}'),
        JSON.parse('{{ zoom | safe }}'),
        projectId,
        layer_names,
    
        );
        
        
        var container = document.getElementById('popup');
        var content = document.getElementById('popup-content');
        
        /**
        * Message to show when the user is drawing a polygon.
        * @type {string}
        */
        var continuePolygonMsg = 'Click to continue polygon, Double click to complete';

        /**
        * Message to show when the user is drawing a line.
        * @type {string}
        */
        var continueLineMsg = 'Click to continue line, Double click to complete';


        var source = new ol.source.Vector();
        var vector = new ol.layer.Vector({
            source: source,
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(102, 255, 232,.5)',
                }),
                stroke: new ol.style.Stroke({
                    color: 'white',
                    width: 2,
                }),
                image: new ol.style.Circle({
                    radius: 7,
                    fill: new ol.style.Fill({
                        color: 'rgba(102, 255, 232,.2)',
                    }),
                }),
            }),
        });

        map.addLayer(vector);
    
            function newaddGeoJsonToMap(url) {

            if (geojson) {
                console.log("newaddgeojson",geojson);
                geojson.getSource().clear();
                map.removeLayer(geojson);
            }

            var style = new ol.style.Style({
                
                stroke: new ol.style.Stroke({
                    color: '#FFFF00',
                    width: 3
                }),
                image: new ol.style.Circle({
                    radius: 7,
                    fill: new ol.style.Fill({
                        color: '#FFFF00'
                    })
                })
            });

            geojson = new ol.layer.Vector({
                source: new ol.source.Vector({
                    url: url,
                    format: new ol.format.GeoJSON()
                }),
                style: style,

            });

            geojson.getSource().on('addfeature', function () {
                map.getView().fit(
                    geojson.getSource().getExtent(),
                    { duration: 1590, size: map.getSize(), maxZoom: 21 }
                );
            });
            map.addLayer(geojson);
        };

        function newpopulateQueryTable(url) {
            if (typeof attributePanel !== 'undefined') {
                if (attributePanel.parentElement !== null) {
                    attributePanel.close();
                }
            }
            $.getJSON(url, function (data) {
                var col = [];
                col.push('id');
                for (var i = 0; i < data.features.length; i++) {

                    for (var key in data.features[i].properties) {

                        if (col.indexOf(key) === -1) {
                            col.push(key);
                        }
                    }
                }

                var table = document.createElement("table");

                table.setAttribute("class", "table table-bordered table-hover table-condensed");
                table.setAttribute("id", "attQryTable");
                // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

                var tr = table.insertRow(-1);                   // TABLE ROW.

                for (var i = 0; i < col.length; i++) {
                    var th = document.createElement("th");      // TABLE HEADER.
                    th.innerHTML = col[i];
                    tr.appendChild(th);
                }

                // ADD JSON DATA TO THE TABLE AS ROWS.
                for (var i = 0; i < data.features.length; i++) {
                    tr = table.insertRow(-1);
                    for (var j = 0; j < col.length; j++) {
                        var tabCell = tr.insertCell(-1);
                        if (j == 0) { tabCell.innerHTML = data.features[i]['id']; }
                        else {
                            tabCell.innerHTML = data.features[i].properties[col[j]];
                        }
                    }
                }

                // var tabDiv = document.createElement("div");
                var tabDiv = document.getElementById('attListDiv');

                var delTab = document.getElementById('attQryTable');
                if (delTab) {
                    tabDiv.removeChild(delTab);
                }

                tabDiv.appendChild(table);

                document.getElementById("attListDiv").style.display = "block";
            });

        };

        var highlightStyle = new ol.style.Style({
            fill: new ol.style.Fill({
            color: 'red',
            }),
            stroke: new ol.style.Stroke({
                color: 'red',
                width: 3,
            }),
            image: new ol.style.Circle({
                radius: 10,
                fill: new ol.style.Fill({
                    color: 'red'
                })
            })
        });


        var featureOverlay = new ol.layer.Vector({
            source: new ol.source.Vector(),
            map: map,
            style: highlightStyle
        });

        function newaddRowHandlers() {
            var table = document.getElementById("attQryTable");
            var rows = document.getElementById("attQryTable").rows;
            var heads = table.getElementsByTagName('th');
            var col_no;
            for (var i = 0; i < heads.length; i++) {
                // Take each cell
                var head = heads[i];
                if (head.innerHTML == 'id') {
                    col_no = i + 1;
                }

            }
            for (i = 0; i < rows.length; i++) {
                rows[i].onclick = function () {
                    return function () {
                        featureOverlay.getSource().clear();

                        $(function () {
                            $("#attQryTable td").each(function () {
                                $(this).parent("tr").css("background-color", "white");
                            });
                        });
                        var cell = this.cells[col_no - 1];
                        var id = cell.innerHTML;
                        $(document).ready(function () {
                            $("#attQryTable td:nth-child(" + col_no + ")").each(function () {
                                if ($(this).text() == id) {
                                    $(this).parent("tr").css("background-color", "#d1d8e2");
                                }
                            });
                        });

                        var features = geojson.getSource().getFeatures();

                        for (i = 0; i < features.length; i++) {
                            if (features[i].getId() == id) {
                                featureOverlay.getSource().addFeature(features[i]);

                                featureOverlay.getSource().on('addfeature', function () {
                                    map.getView().fit(
                                        featureOverlay.getSource().getExtent(),
                                        { duration: 1500, size: map.getSize(), maxZoom: 24 }
                                    );
                                });

                            }
                        }
                    };
                }(rows[i]);
            }
        }

        // end : attribute query   
       
        
</script>

    
{% endblock %}

